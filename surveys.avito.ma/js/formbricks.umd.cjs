!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).formbricks=t()}(this,(function(){"use strict";var e=Object.defineProperty,t=(t,n,r)=>((t,n,r)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r)(t,"symbol"!=typeof n?n+"":n,r);const n="formbricks-js",r="formbricks-js-website",s="formbricks-js-app",i="formbricks-app-container",a=class e{constructor(){t(this,"logLevel","error")}static getInstance(){return e.instance||(e.instance=new e),e.instance}configure(e){e&&void 0!==e.logLevel&&(this.logLevel=e.logLevel)}logger(e,t){if("debug"===t&&"debug"!==this.logLevel)return;const n=`ðŸ§± Formbricks - ${(new Date).toISOString()} [${t.toUpperCase()}] - ${e}`;"error"===t?console.error(n):console.log(n)}debug(e){this.logger(e,"debug")}error(e){this.logger(e,"error")}};t(a,"instance");let o=a;const d=e=>({ok:!0,value:e}),l=e=>({ok:!1,error:e});const c=e=>(...t)=>{try{return{ok:!0,value:e(...t)}}catch(n){return{ok:!1,error:n}}},u=o.getInstance(),g=class e{constructor(e){t(this,"handleError"),t(this,"customized",!1),e?(this.handleError=e,this.customized=!0):this.handleError=e=>o.getInstance().error(JSON.stringify(e))}static getInstance(){return e.instance||(e.instance=new e),e.instance}static init(t){this.initialized=!0,e.instance=new e(t)}printStatus(){u.debug("Custom error handler: "+(this.customized?"yes":"no"))}handle(e){console.warn("ðŸ§± Formbricks - Global error: ",e),this.handleError(e)}};t(g,"instance"),t(g,"initialized",!1);let p=g;const v=class e{constructor(){t(this,"config",null);const e=this.loadFromLocalStorage();e.ok&&(this.config=e.value)}static getInstance(){return e.instance||(e.instance=new e),e.instance}update(e){var t,n;e&&(this.config={...this.config,...e,status:{value:(null==(t=e.status)?void 0:t.value)||"success",expiresAt:(null==(n=e.status)?void 0:n.expiresAt)||null}},this.saveToStorage())}get(){if(!this.config)throw new Error("config is null, maybe the init function was not called?");return this.config}loadFromLocalStorage(){var e;if("undefined"!=typeof window){const t=localStorage.getItem(n);if(t){const n=JSON.parse(t);return(null==(e=n.environmentState)?void 0:e.expiresAt)&&new Date(n.environmentState.expiresAt)<=new Date?l(new Error("Config in local storage has expired")):d(n)}}return l(new Error("No or invalid config in local storage"))}async saveToStorage(){return c((async()=>{await localStorage.setItem(n,JSON.stringify(this.config))}))()}async resetConfig(){return this.config=null,c((async()=>{localStorage.removeItem(n)}))()}};t(v,"instance");let h=v;var f=Object.defineProperty,m=(e,t,n)=>((e,t,n)=>t in e?f(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n)(e,"symbol"!=typeof t?t+"":t,n);const y=e=>({ok:!1,error:e}),w=async(e,t,n,r)=>{const s=new URL(e+t),i=r?JSON.stringify(r):void 0,a=await(o=fetch,async(...e)=>{try{return{ok:!0,data:await o(...e)}}catch(t){return{ok:!1,error:t}}})(s.toString(),{method:n,headers:{"Content-Type":"application/json"},body:i});var o;if(!a.ok)return y(a.error);const d=a.data,l=await d.json();if(!d.ok){const e=l;return y({code:"forbidden"===e.code?"forbidden":"network_error",status:d.status,message:e.message||"Something went wrong",url:s,...Object.keys(e.details).length>0&&{details:e.details}})}return(e=>({ok:!0,data:e}))(l.data)};class I{constructor(e,t){m(this,"apiHost"),m(this,"environmentId"),this.apiHost=e,this.environmentId=t}async update(e){const t={};for(const n in e.attributes)t[n]=String(e.attributes[n]);return w(this.apiHost,`/api/v1/client/${this.environmentId}/contacts/${e.userId}/attributes`,"PUT",{attributes:t})}}class S{constructor(e,t){m(this,"apiHost"),m(this,"environmentId"),this.apiHost=e,this.environmentId=t}async create(e){return w(this.apiHost,`/api/v1/client/${this.environmentId}/displays`,"POST",e)}}class b{constructor(e,t){m(this,"apiHost"),m(this,"environmentId"),this.apiHost=e,this.environmentId=t}async create(e){return w(this.apiHost,`/api/v1/client/${this.environmentId}/responses`,"POST",e)}async update({responseId:e,finished:t,endingId:n,data:r,ttc:s,variables:i,language:a}){return w(this.apiHost,`/api/v1/client/${this.environmentId}/responses/${e}`,"PUT",{finished:t,endingId:n,data:r,ttc:s,variables:i,language:a})}}class k{constructor(e,t){m(this,"apiHost"),m(this,"environmentId"),this.apiHost=e,this.environmentId=t}async uploadFile(e,{allowedFileExtensions:t,surveyId:n}={}){if(!e.name||!e.type||!e.base64)throw new Error("Invalid file object");const r={fileName:e.name,fileType:e.type,allowedFileExtensions:t,surveyId:n},s=await fetch(`${this.apiHost}/api/v1/client/${this.environmentId}/storage`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!s.ok)throw new Error(`Upload failed with status: ${String(s.status)}`);const i=await s.json(),{data:a}=i,{signedUrl:o,fileUrl:d,signingData:l,presignedFields:c,updatedFileName:u}=a;let g={};if(l){const{signature:t,timestamp:r,uuid:s}=l;g={"X-File-Type":e.type,"X-File-Name":encodeURIComponent(u),"X-Survey-ID":n??"","X-Signature":t,"X-Timestamp":String(r),"X-UUID":s}}const p={},v=new FormData;if(c){Object.entries(c).forEach((([e,t])=>{v.append(e,t)}));try{const t=atob(e.base64.split(",")[1]),n=Uint8Array.from([...t].map((e=>e.charCodeAt(0)))),r=new Blob([n],{type:e.type});v.append("file",r)}catch(m){throw console.error(m),new Error("Error uploading file")}}p.fileBase64String=e.base64;let h={};const f=o.replace("http://localhost:3000",this.apiHost);try{h=await fetch(f,{method:"POST",...l?{headers:{...g}}:{},body:c?v:JSON.stringify(p)})}catch(m){console.error("Error uploading file",m)}if(!h.ok){if(l){const e=await h.json(),t=new Error(e.message);throw t.name="FileTooLargeError",t}const e=await h.text();if(c&&e.includes("EntityTooLarge")){const e=new Error("File size exceeds the size limit for your plan");throw e.name="FileTooLargeError",e}throw new Error(`Upload failed with status: ${String(h.status)}`)}return d}}class C{constructor(e){m(this,"response"),m(this,"display"),m(this,"storage"),m(this,"attribute");const{apiHost:t,environmentId:n}=e;this.response=new b(t,n),this.display=new S(t,n),this.attribute=new I(t,n),this.storage=new k(t,n)}}class E{constructor(e){m(this,"client"),this.client=new C(e)}}const H=e=>new Promise((t=>setTimeout(t,e)));class A{constructor(e,n){t(this,"queue",[]),t(this,"config"),t(this,"surveyState"),t(this,"isRequestInProgress",!1),t(this,"api"),this.config=e,this.surveyState=n,this.api=new E({apiHost:e.apiHost,environmentId:e.environmentId})}add(e){this.surveyState.accumulateResponse(e),this.config.setSurveyState&&this.config.setSurveyState(this.surveyState),this.queue.push(e),this.processQueue()}async processQueue(){if(this.isRequestInProgress)return;if(0===this.queue.length)return;this.isRequestInProgress=!0;const e=this.queue[0];let t=0;for(;t<this.config.retryAttempts;){if(await this.sendResponse(e)){this.queue.shift();break}console.error(`Formbricks: Failed to send response. Retrying... ${t}`),await H(1e3),t++}t>=this.config.retryAttempts?(console.error("Failed to send response after 2 attempts."),this.config.onResponseSendingFailed&&this.config.onResponseSendingFailed(e),this.isRequestInProgress=!1):(e.finished&&this.config.onResponseSendingFinished&&this.config.onResponseSendingFinished(),this.isRequestInProgress=!1,this.processQueue())}async sendResponse(e){try{if(null!==this.surveyState.responseId)await this.api.client.response.update({...e,responseId:this.surveyState.responseId});else{const t=await this.api.client.response.create({...e,surveyId:this.surveyState.surveyId,userId:this.surveyState.userId||null,singleUseId:this.surveyState.singleUseId||null,data:{...e.data,...e.hiddenFields},displayId:this.surveyState.displayId});if(!t.ok)throw new Error("Could not create response");this.surveyState.updateResponseId(t.data.id),this.config.setSurveyState&&this.config.setSurveyState(this.surveyState)}return!0}catch(t){return console.error(t),!1}}updateSurveyState(e){this.surveyState=e}}class F{constructor(e,n,r,s){t(this,"responseId",null),t(this,"displayId",null),t(this,"userId",null),t(this,"surveyId"),t(this,"responseAcc",{finished:!1,data:{},ttc:{},variables:{}}),t(this,"singleUseId"),this.surveyId=e,this.userId=s??null,this.singleUseId=n??null,this.responseId=r??null}setSurveyId(e){this.surveyId=e,this.clear()}copy(){const e=new F(this.surveyId,this.singleUseId??void 0,this.responseId??void 0,this.userId??void 0);return e.responseId=this.responseId,e.responseAcc=this.responseAcc,e}updateResponseId(e){this.responseId=e}updateDisplayId(e){this.displayId=e}updateUserId(e){this.userId=e}accumulateResponse(e){this.responseAcc={finished:e.finished,ttc:e.ttc,data:{...this.responseAcc.data,...e.data},variables:e.variables,displayId:e.displayId}}isResponseFinished(){return this.responseAcc.finished}clear(){this.responseId=null,this.responseAcc={finished:!1,data:{},ttc:{},variables:{}}}}const $=(e,t)=>{var n;return e.styling.allowStyleOverwrite&&e.styling.allowStyleOverwrite&&(null==(n=t.styling)?void 0:n.overwriteThemeStyling)?t.styling:e.styling},D=(e,t)=>{const n=Math.abs(t.getTime()-e.getTime());return Math.floor(n/864e5)},O=o.getInstance(),x=e=>{if(!e||0===e.length)return!0;const t=window.location.href;return e.some((e=>((e,t,n)=>{switch(n){case"exactMatch":return e===t;case"contains":return e.includes(t);case"startsWith":return e.startsWith(t);case"endsWith":return e.endsWith(t);case"notMatch":return e!==t;case"notContains":return!e.includes(t);default:return!1}})(t,e.value,e.rule)))},L=e=>{var t;const n=null==(t=e.languages)?void 0:t.find((e=>!0===e.default));if(n)return n.language.code},P=()=>window.location.search.includes("formbricksDebug=true"),R=(e,t)=>{const{project:n,surveys:r}=e.data,{displays:s,responses:i,lastDisplayAt:a,segments:o,userId:d}=t.data;if(!s)return[];let l=r.filter((e=>{switch(e.displayOption){case"respondMultiple":return!0;case"displayOnce":return 0===s.filter((t=>t.surveyId===e.id)).length;case"displayMultiple":return 0===i.filter((t=>t===e.id)).length;case"displaySome":return null===e.displayLimit||!i.filter((t=>t===e.id)).length&&s.filter((t=>t.surveyId===e.id)).length<e.displayLimit;default:throw Error("Invalid displayOption")}}));return l=l.filter((e=>{if(a){if(null!==e.recontactDays){const t=s.filter((t=>t.surveyId===e.id))[0];return!t||D(new Date,new Date(t.createdAt))>=e.recontactDays}return null===n.recontactDays||D(new Date,new Date(a))>=n.recontactDays}return!0})),d?o.length?l.filter((e=>{var t;return(null==(t=e.segment)?void 0:t.id)&&o.includes(e.segment.id)})):[]:l},j=h.getInstance(),T=o.getInstance();let U=!1,N=e=>{},z=e=>{};const M=e=>{U=e},q=async(e,t,n)=>{if(e.displayPercentage){if(!(r=e.displayPercentage,Math.floor(1e4*Math.random())/100<=r))return void T.debug(`Survey display of "${e.name}" skipped based on displayPercentage.`)}var r;const s=((e,t)=>{const{enabled:n,fieldIds:r}=e||{};let s={};if(n){if(r&&t){const e=[];s=Object.keys(t).reduce(((n,s)=>((null==r?void 0:r.includes(s))?n[s]=null==t?void 0:t[s]:e.push(s),n)),{}),e.length>0&&O.error(`Unknown hidden fields: ${e.join(", ")}. Please add them to the survey hidden fields.`)}}else O.error("Hidden fields are not enabled for this survey");return s})(e.hiddenFields,null==n?void 0:n.hiddenFields);await J(e,t,s)},J=async(e,t,n={})=>{if(U)return void T.debug("A survey is already running. Skipping.");M(!0),e.delay&&T.debug(`Delaying survey "${e.name}" by ${e.delay} seconds.`);const{project:r}=j.get().environmentState.data??{},{attributes:s}=j.get()??{},i=e.languages.length>1;let a="default";if(i){const t=((e,t)=>{const n=t.language,r=e.languages.map((e=>e.language.code));if(n){const t=e.languages.find((e=>{var t;return e.language.code===n.toLowerCase()||(null==(t=e.language.alias)?void 0:t.toLowerCase())===n.toLowerCase()}));if(null==t?void 0:t.default)return"default";if(!t||!(null==t?void 0:t.enabled)||!r.includes(t.language.code))return;return t.language.code}return"default"})(e,s);if(!t)return T.debug(`Survey "${e.name}" is not available in specified language.`),void M(!0);a=t}const o=new F(e.id,null,null,j.get().personState.data.userId),d=new A({apiHost:j.get().apiHost,environmentId:j.get().environmentId,retryAttempts:2,onResponseSendingFailed:()=>{N(!0)},onResponseSendingFinished:()=>{z(!0)}},o),l=e.projectOverwrites??{},c=l.clickOutsideClose??r.clickOutsideClose,u=l.darkOverlay??r.darkOverlay,g=l.placement??r.placement,p=r.inAppSurveyBranding,v=await Q();setTimeout((()=>{v.renderSurveyModal({survey:e,isBrandingEnabled:p,clickOutside:c,darkOverlay:u,languageCode:a,placement:g,styling:$(r,e),getSetIsError:e=>{N=e},getSetIsResponseSendingFinished:e=>{z=e},onDisplay:async()=>{const{userId:t}=j.get().personState.data,n=new E({apiHost:j.get().apiHost,environmentId:j.get().environmentId}),r=await n.client.display.create({surveyId:e.id,...t&&{userId:t}});if(!r.ok)throw new Error("Could not create display");const{id:s}=r.data;o.updateDisplayId(s),d.updateSurveyState(o);const i=j.get().personState.data.displays,a={surveyId:e.id,createdAt:new Date},l=i?[...i,a]:[a],c=j.get(),u={...c.personState,data:{...c.personState.data,displays:l,lastDisplayAt:new Date}},g=R(c.environmentState,u);j.update({...c,environmentState:c.environmentState,personState:u,filteredSurveys:g})},onResponse:r=>{const{userId:s}=j.get().personState.data,i=null===o.responseId;if(s&&o.updateUserId(s),d.updateSurveyState(o),d.add({data:r.data,ttc:r.ttc,finished:r.finished,language:"default"===r.language?L(e):r.language,meta:{url:window.location.href,action:t},variables:r.variables,hiddenFields:n,displayId:o.displayId}),i){const e=j.get().personState.data.responses,t={...j.get().personState,data:{...j.get().personState.data,responses:[...e,o.surveyId]}},n=R(j.get().environmentState,t);j.update({...j.get(),environmentState:j.get().environmentState,personState:t,filteredSurveys:n})}},onClose:_,onFileUpload:async(e,t)=>{const n=new E({apiHost:j.get().apiHost,environmentId:j.get().environmentId});return await n.client.storage.uploadFile({type:e.type,name:e.name,base64:e.base64},t)},onRetry:()=>{N(!1),d.processQueue()},hiddenFieldsRecord:n})}),1e3*e.delay)},_=async()=>{B(),X();const{environmentState:e,personState:t}=j.get(),n=R(e,t);j.update({...j.get(),environmentState:e,personState:t,filteredSurveys:n}),M(!1)},X=()=>{const e=document.createElement("div");e.id=i,document.body.appendChild(e)},B=()=>{var e;null==(e=document.getElementById(i))||e.remove()},Q=()=>new Promise(((e,t)=>{if(window.formbricksSurveys)e(window.formbricksSurveys);else{const n=document.createElement("script");n.src=`${j.get().apiHost}/js/surveys.umd.cjs`,n.async=!0,n.onload=()=>e(window.formbricksSurveys),n.onerror=e=>{console.error("Failed to load Formbricks Surveys library:",e),t(e)},document.head.appendChild(n)}})),W=o.getInstance(),Y=h.getInstance(),G=async(e,t,n)=>{const r=t||e;W.debug(`Formbricks: Action "${r}" tracked`);const s=Y.get().filteredSurveys;if(s&&s.length>0)for(const i of s)for(const t of i.triggers)t.actionClass.name===e&&await q(i,e,n);else W.debug("No active surveys to display");return{ok:!0,value:void 0}},V=(e,t)=>{const n=Y.get().environmentState.data.actionClasses.filter((e=>"code"===e.type)).find((t=>t.key===e));return n?G(n.name,e,t):l({code:"invalid_code",message:`${e} action unknown. Please add this action in Formbricks first in order to use it in your code.`})},K=e=>G(e),Z=h.getInstance(),ee=o.getInstance();let te=null;const ne={expiresAt:null,data:{userId:null,segments:[],displays:[],responses:[],lastDisplayAt:null}},re=async({apiHost:e,environmentId:t,userId:n},r=!1)=>{let s={};(r||P())&&(s.cache="no-cache",ee.debug("No cache option set for sync"));const i=`${e}/api/v1/client/${t}/identify/contacts/${n}`,a=await fetch(i,s);if(!a.ok){const e=await a.json();throw l({code:"forbidden"===e.code?"forbidden":"network_error",status:a.status,message:"Error syncing with backend",url:new URL(i),responseMessage:e.message})}const o=await a.json(),{data:d}=o,c={expiresAt:new Date((new Date).getTime()+18e5),data:{userId:n,segments:[],displays:[],responses:[],lastDisplayAt:null}};return Object.keys(d).length?{data:{...d},expiresAt:new Date((new Date).getTime()+18e5)}:c},se=()=>{te&&(clearInterval(te),te=null)},ie=h.getInstance(),ae=o.getInstance(),oe=async(e,t)=>{if("userId"===e)return ae.error("Setting userId is no longer supported. Please set the userId in the init call instead."),{ok:!0,value:void 0};const n=ie.get().personState.data.userId;if(ae.debug("Setting attribute: "+e+" to value: "+t),!n)return ae.error("UserId not provided, please provide a userId in the init method before setting attributes."),{ok:!0,value:void 0};const r=await(async(e,t)=>{var n;const{apiHost:r,environmentId:s}=ie.get(),i=ie.get().personState.data.userId;if(!i)return l({code:"network_error",status:500,message:"Missing userId",url:`${r}/api/v1/client/${s}/contacts/${i}/attributes`,responseMessage:"Missing userId"});const a=new E({apiHost:r,environmentId:s}),o=await a.client.attribute.update({userId:i,attributes:{[e]:t}});return o.ok?(o.data.details&&Object.entries(o.data.details).forEach((([e,t])=>{ae.error(`${e}: ${t}`)})),o.data.changed?(ae.debug("Attribute updated in Formbricks"),{ok:!0,value:{changed:!0,message:"Attribute updated in Formbricks",...o.data.details&&{details:o.data.details}}}):{ok:!0,value:{changed:!1,message:"Attribute not updated in Formbricks",...o.data.details&&{details:o.data.details}}}):(null==(n=o.error.details)?void 0:n.ignore)?(ae.error(o.error.message??`Error updating person with userId ${i}`),{ok:!0,value:{changed:!1,message:o.error.message}}):l({code:o.error.code??"network_error",status:o.error.status??500,message:`Error updating person with userId ${i}`,url:new URL(`${r}/api/v1/client/${s}/contacts/${i}/attributes`),responseMessage:o.error.message})})(e,t.toString());if(r.ok){if(r.value.changed){const r=await re({apiHost:ie.get().apiHost,environmentId:ie.get().environmentId,userId:n},!0),s=R(ie.get().environmentState,r);ie.update({...ie.get(),personState:r,filteredSurveys:s,attributes:{...ie.get().attributes,[e]:t.toString()}})}return{ok:!0,value:void 0}}{const e=r.error;e&&"forbidden"===e.code&&ae.error(`Authorization error: ${e.responseMessage}`)}return l(r.error)},de=e=>async(...t)=>{try{return{ok:!0,data:await e(...t)}}catch(n){return{ok:!1,error:n}}},le=h.getInstance(),ce=o.getInstance();let ue=null;const ge=async({apiHost:e,environmentId:t},n=!1)=>{let r={};(n||P())&&(r.cache="no-cache",ce.debug("No cache option set for sync"));const s=`${e}/api/v1/client/${t}/environment`,i=await fetch(s,r);if(!i.ok){const e=await i.json();throw l({code:"network_error",status:i.status,message:"Error syncing with backend",url:new URL(s),responseMessage:e.message})}const a=await i.json(),{data:o}=a;return{data:{...o},expiresAt:new Date((new Date).getTime()+18e5)}},pe=()=>{ue&&(clearInterval(ue),ue=null)},ve=h.getInstance(),he=o.getInstance(),fe=p.getInstance(),me=["hashchange","popstate","pushstate","replacestate","load"];let ye=!1;const we=async()=>{var e;he.debug(`Checking page url: ${window.location.href}`);const t=ve.get().environmentState.data.actionClasses.filter((e=>{var t;return"noCode"===e.type&&"pageView"===(null==(t=e.noCodeConfig)?void 0:t.type)}));for(const n of t){const t=(null==(e=n.noCodeConfig)?void 0:e.urlFilters)??[];if(!x(t))continue;const r=await K(n.name);if(!0!==r.ok)return l(r.error)}return{ok:!0,value:void 0}},Ie=()=>we(),Se=()=>{"undefined"!=typeof window&&ye&&(me.forEach((e=>window.removeEventListener(e,Ie))),ye=!1)};let be=!1;const ke=e=>{const{environmentState:t}=ve.get();if(!t)return;const{actionClasses:n=[]}=t.data,r=n.filter((e=>{var t;return"noCode"===e.type&&"click"===(null==(t=e.noCodeConfig)?void 0:t.type)})),s=e.target;r.forEach((e=>{((e,t)=>{var n;if("click"!==(null==(n=t.noCodeConfig)?void 0:n.type))return!1;const r=t.noCodeConfig.elementSelector.innerHtml,s=t.noCodeConfig.elementSelector.cssSelector,i=t.noCodeConfig.urlFilters;if(!r&&!s)return!1;if(r&&e.innerHTML!==r)return!1;if(s){const t=s.split(/\s*(?=[.#])/);for(let n of t)if(!e.matches(n))return!1}return!!x(i)})(s,e)&&K(e.name).then((e=>{var t,n,r;n=e=>{},r=e=>fe.handle(e),!0===(t=e).ok?n(t.value):r(t.error)}))}))},Ce=e=>ke(e),Ee=()=>{be&&(document.removeEventListener("click",Ce),be=!1)};let He=!1;const Ae=e=>(async e=>{var t;const{environmentState:n}=ve.get(),{actionClasses:r=[]}=n.data??{},s=r.filter((e=>{var t;return"noCode"===e.type&&"exitIntent"===(null==(t=e.noCodeConfig)?void 0:t.type)}));if(e.clientY<=0&&s.length>0)for(const i of s){const e=(null==(t=i.noCodeConfig)?void 0:t.urlFilters)??[];if(!x(e))continue;const n=await K(i.name);if(!0!==n.ok)return l(n.error)}})(e),Fe=()=>{He&&(document.removeEventListener("mouseleave",Ae),He=!1)};let $e=!1,De=!1;const Oe=()=>(async()=>{var e;const t=window.scrollY,n=window.innerHeight,r=document.documentElement.scrollHeight;if(0===t&&(De=!1),!De&&t/(r-n)>=.5){De=!0;const{environmentState:t}=ve.get(),{actionClasses:n=[]}=t.data??{},r=n.filter((e=>{var t;return"noCode"===e.type&&"fiftyPercentScroll"===(null==(t=e.noCodeConfig)?void 0:t.type)}));for(const s of r){const t=(null==(e=s.noCodeConfig)?void 0:e.urlFilters)??[];if(!x(t))continue;const n=await K(s.name);if(!0!==n.ok)return l(n.error)}}return{ok:!0,value:void 0}})(),xe=()=>{$e&&(window.removeEventListener("scroll",Oe),$e=!1)};let Le=!1;const Pe=()=>{"undefined"!=typeof window&&null===ue&&(ue=window.setInterval((async()=>{const e=le.get().environmentState.expiresAt;try{if(e&&new Date(e)>=new Date)return;ce.debug("Environment State has expired. Starting sync.");const t=le.get().personState,n=await ge({apiHost:le.get().apiHost,environmentId:le.get().environmentId},!0),r=R(n,t);le.update({...le.get(),environmentState:n,filteredSurveys:r})}catch(t){console.error(`Error during expiry check: ${t}`),ce.debug("Extending config and try again later.");const e=le.get();le.update(e)}}),6e4)),"undefined"!=typeof window&&null===te&&(te=window.setInterval((async()=>{Z.get().personState.data.userId&&Z.update({...Z.get(),personState:{...Z.get().personState,expiresAt:new Date((new Date).getTime()+18e5)}})}),6e4)),"undefined"==typeof window||ye||(me.forEach((e=>window.addEventListener(e,Ie))),ye=!0),"undefined"==typeof window||be||(document.addEventListener("click",Ce),be=!0),"undefined"==typeof document||He||(document.querySelector("body").addEventListener("mouseleave",Ae),He=!0),"undefined"==typeof window||$e||("complete"===document.readyState?window.addEventListener("scroll",Oe):window.addEventListener("load",(()=>{window.addEventListener("scroll",Oe)})),$e=!0)},Re=()=>{pe(),se(),Se(),Ee(),Fe(),xe(),Le&&(window.removeEventListener("beforeunload",(()=>{pe(),se(),Se(),Ee(),Fe(),xe()})),Le=!1)},je=o.getInstance();let Te=!1;const Ue=e=>{Te=e},Ne=async e=>{var t,i;const a=P();a&&je.configure({logLevel:"debug"});let o=h.getInstance();const{changed:c,newState:u}=(()=>{const e=localStorage.getItem(r),t=localStorage.getItem(s);if(e){localStorage.removeItem(r);const t=JSON.parse(e);if(t.environmentId&&t.apiHost&&t.environmentState&&t.personState&&t.filteredSurveys)return{changed:!0,newState:{...t}}}if(t){localStorage.removeItem(s);const e=JSON.parse(t);if(e.environmentId&&e.apiHost&&e.environmentState&&e.personState&&e.filteredSurveys)return{changed:!0}}return{changed:!1}})();c&&(o.resetConfig(),o=h.getInstance(),!e.userId&&u&&o.update(u));const{changed:g,newState:v}=(()=>{const e=localStorage.getItem(n);if(e){const t=JSON.parse(e);if(t.environmentState.data.product){const{environmentState:e,filteredSurveys:n,...r}=t,s=n.map((e=>{const{productOverwrites:t,...n}=e;return{...n,projectOverwrites:t}})),{product:i,...a}=t.environmentState.data;return{changed:!0,newState:{...r,environmentState:{...t.environmentState,data:{...a,project:i}},filteredSurveys:s}}}}return{changed:!1}})();if(g&&(o.resetConfig(),o=h.getInstance(),v&&o.update(v)),Te)return je.debug("Already initialized, skipping initialization."),{ok:!0,value:void 0};let f;try{f=o.get(),je.debug("Found existing configuration.")}catch(m){je.debug("No existing configuration found.")}if("error"===(null==(t=null==f?void 0:f.status)?void 0:t.value)){if(a)return je.debug("Formbricks is in error state, but debug mode is active. Resetting config and continuing."),o.resetConfig(),{ok:!0,value:void 0};je.debug("Formbricks was set to an error state.");const e=null==(i=null==f?void 0:f.status)?void 0:i.expiresAt;if(e&&new Date(e)>new Date)return je.debug("Error state is not expired, skipping initialization"),{ok:!0,value:void 0};je.debug("Error state is expired. Continue with initialization.")}if(p.getInstance().printStatus(),je.debug("Start initialize"),!e.environmentId)return je.debug("No environmentId provided"),l({code:"missing_field",field:"environmentId"});if(!e.apiHost)return je.debug("No apiHost provided"),l({code:"missing_field",field:"apiHost"});if(je.debug("Adding widget container to DOM"),X(),f&&f.environmentState&&f.environmentId===e.environmentId&&f.apiHost===e.apiHost){je.debug("Configuration fits init parameters.");let t=!1,n=!1;new Date(f.environmentState.expiresAt)<new Date&&(je.debug("Environment state expired. Syncing."),t=!0),e.userId&&(null===f.personState||f.personState.expiresAt&&new Date(f.personState.expiresAt)<new Date)&&(je.debug("Person state needs syncing - either null or expired"),n=!0);try{const r=t?await ge({apiHost:e.apiHost,environmentId:e.environmentId}):f.environmentState;let{personState:s}=f;n&&(s=e.userId?await re({apiHost:e.apiHost,environmentId:e.environmentId,userId:e.userId}):ne);const i=R(r,s);o.update({...f,environmentState:r,personState:s,filteredSurveys:i,attributes:e.attributes??{}});const a=i.map((e=>e.name));je.debug("Fetched "+a.length+" surveys during sync: "+a.join(", "))}catch(m){qe(o)}}else{je.debug("No valid configuration found. Resetting config and creating new one."),o.resetConfig(),je.debug("Syncing.");try{const t=await ge({apiHost:e.apiHost,environmentId:e.environmentId},!1),n=e.userId?await re({apiHost:e.apiHost,environmentId:e.environmentId,userId:e.userId},!1):ne,r=R(t,n);let s=null;if(e.attributes)if(e.userId){const t=await(async(e,t,n,r)=>{var s;const i={...r};if(0===Object.keys(i).length)return ae.debug("No attributes to update. Skipping update."),d(i);ae.debug("Updating attributes: "+JSON.stringify(i));const a=new E({apiHost:e,environmentId:t}),o=await a.client.attribute.update({userId:n,attributes:i});return o.ok?(o.data.details&&Object.entries(o.data.details).forEach((([e,t])=>{ae.debug(`${e}: ${t}`)})),d(i)):(null==(s=o.error.details)?void 0:s.ignore)?(ae.error(o.error.message??`Error updating person with userId ${n}`),d(i)):l({code:o.error.code??"network_error",status:o.error.status??500,message:`Error updating person with userId ${n}`,url:new URL(`${e}/api/v1/client/${t}/people/${n}/attributes`),responseMessage:o.error.message})})(e.apiHost,e.environmentId,e.userId,e.attributes);if(!0!==t.ok)return"forbidden"===t.error.code&&je.error(`Authorization error: ${t.error.responseMessage}`),l(t.error);s=t.value}else s={...e.attributes};o.update({apiHost:e.apiHost,environmentId:e.environmentId,personState:n,environmentState:t,filteredSurveys:r,attributes:s??{}})}catch(m){ze(m)}await K("New Session")}return je.debug("Adding event listeners"),Pe(),Le||(window.addEventListener("beforeunload",(()=>{pe(),se(),Se(),Ee(),Fe(),xe()})),Le=!0),Ue(!0),je.debug("Initialized"),we(),{ok:!0,value:void 0}},ze=e=>{if("forbidden"===e.error.code&&je.error(`Authorization error: ${e.error.responseMessage}`),P())return void je.debug("Not putting formbricks in error state because debug mode is active (no error state)");const t={status:{value:"error",expiresAt:new Date((new Date).getTime()+6e5)}};throw c((()=>localStorage.setItem(n,JSON.stringify(t))))(),new Error("Could not initialize formbricks")},Me=()=>{je.debug("Deinitializing"),B(),M(!1),Re(),Ue(!1)},qe=e=>{P()?je.debug("Not putting formbricks in error state because debug mode is active (no error state)"):(je.debug("Putting formbricks in error state"),e.update({...e.get(),status:{value:"error",expiresAt:new Date((new Date).getTime()+6e5)}}),Me())};const Je=h.getInstance(),_e=o.getInstance(),Xe=async()=>{Me(),Je.resetConfig()},Be=async()=>{_e.debug("Resetting state & getting new state from backend"),_();const e=Je.get().personState.data.userId,t={environmentId:Je.get().environmentId,apiHost:Je.get().apiHost,...e&&{userId:e},attributes:Je.get().attributes};await Xe();try{return await Ne(t),{ok:!0,value:void 0}}catch(n){return l(n)}};o.getInstance().debug("Create command queue");const Qe=new class{constructor(){t(this,"queue",[]),t(this,"running",!1),t(this,"resolvePromise",null),t(this,"commandPromise",null)}add(e=!0,t,...n){this.queue.push({command:t,checkInitialized:e,commandArgs:n}),this.running||(this.commandPromise=new Promise((e=>{this.resolvePromise=e,this.run()})))}async wait(){this.running&&await this.commandPromise}async run(){for(this.running=!0;this.queue.length>0;){const e=p.getInstance(),t=this.queue.shift();if(!t)continue;if(t.checkInitialized){const t=(je.debug("Check if initialized"),Te&&p.initialized?{ok:!0,value:void 0}:l({code:"not_initialized",message:"Formbricks not initialized. Call initialize() first."}));if(t&&!0!==t.ok){e.handle(t.error);continue}}const n=async()=>await(null==t?void 0:t.command.apply(null,null==t?void 0:t.commandArgs)),r=await de(n)();r&&(r.ok&&r.data&&!r.data.ok&&e.handle(r.data.error),!0!==r.ok&&e.handle(r.error))}this.running=!1,this.resolvePromise&&(this.resolvePromise(),this.resolvePromise=null,this.commandPromise=null)}},We=async(e,t)=>{Qe.add(!0,oe,e,t),await Qe.wait()};return{init:async e=>{p.init(e.errorHandler),Qe.add(!1,Ne,e),await Qe.wait()},setEmail:async e=>{We("email",e),await Qe.wait()},setAttribute:We,track:async(e,t)=>{Qe.add(!0,V,e,t),await Qe.wait()},logout:async()=>{Qe.add(!0,Xe),await Qe.wait()},reset:async()=>{Qe.add(!0,Be),await Qe.wait()},registerRouteChange:async()=>{Qe.add(!0,we),await Qe.wait()},getApi:()=>{const e=h.getInstance(),{environmentId:t,apiHost:n}=e.get();if(!t||!n)throw new Error("formbricks.init() must be called before getApi()");return new E({apiHost:n,environmentId:t})}}}));
//# sourceMappingURL=index.umd.cjs.map
